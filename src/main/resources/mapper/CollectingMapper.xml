<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.douzone.lis_back.mapper.collecting.CollectingMapper">

    <update id="updateCollectingData">
        update collecting
        set collecting_dt = now(), collector_id = #{userId}
        where prescribe_code in (
        <foreach collection="barcodeList" item="item" separator=",">
            #{item}
        </foreach>
        ) and isnull(cancel_barcode_dt)  and is_canceled_inspection = 0;
        -- FIXME 채혈자 id 토큰에 있는걸로 할것
    </update>

    <select id="findPrescribeCodeByBarcode" resultType="String">
        select prescribe_code
        from collecting
        where prescribe_code in (
            <foreach collection="prescribeCodes" item="item" separator=",">
                #{item}
            </foreach>
            )

    </select>

    <update id="deleteCollectingData">
        update collecting
           set cancel_collecting_dt = now(), cancel_collecting_id = #{userId},collecting_dt = null, collector_id = null
         where prescribe_code in(
             <foreach collection="barcodeList" item="item" separator=",">
                 #{item}
             </foreach>
             )and isnull(cancel_barcode_dt);
    </update>
    <update id="updateCancelInspection">
        update collecting
        set is_canceled_inspection = ${status}
        where prescribe_code in (
        <foreach collection="prescribeCode" item="item" separator=",">
            ${item}
        </foreach>
        )
    </update>
    <select id="colletData" resultType="com.douzone.lis_back.domain.collectdomain.CollectDomainDTO">
        select DISTINCT
            collecting.barcode,collecting_dt,collector_id,collecting.prescribe_code,
            unsuitable_reason.unsuitable_status_code,
            prescribe.status_code,
            order_slip.order_code,order_slip.vessel_code,
            visit.patient_no,
            vessel.sample_code,
            collecting.cancel_barcode_dt,collecting.cancel_collecting_dt
        from collecting
                 left join unsuitable_status_management on collecting.barcode = unsuitable_status_management.barcode
                 left join unsuitable_reason on unsuitable_status_management.unsuitable_reason_code = unsuitable_reason.unsuitable_reason_code
                 join prescribe on collecting.prescribe_code = prescribe.prescribe_code
                 join visit on prescribe.visit_code = visit.visit_code
                 join order_slip on prescribe.order_code = order_slip.order_code
                 join vessel on order_slip.vessel_code = vessel.vessel_code
        where collecting.barcode = #{barcode} and (prescribe.status_code = 'C' or prescribe.status_code = 'D') and collecting.cancel_barcode_dt is null and collecting.cancel_collecting_dt is null;
    </select>

    <select id="getCode" resultType="String" parameterType = "Map">
        select prescribe_code
        from collecting
        where barcode = #{barcode};
    </select>

    <select id="findCollectedPrescribeCode" resultType="String">
        select prescribe_code
        from collecting
        where prescribe_code in
        (
        <foreach collection="barcodeList" item="item" separator=",">
            #{item}
        </foreach>
        )
        and (!isnull(collecting_dt))
        and isnull(cancel_collecting_dt);
    </select>
</mapper>

        <!--        CREATE TABLE `collecting` (-->
        <!--        `barcode`	varchar(30)	NOT NULL,-->
        <!--        `status_code`	varchar(2)	NOT NULL,-->
        <!--        `barcode_dt`	datetime	NOT NULL,-->
        <!--        `collecting_dt`	datetime	NULL,-->
        <!--        `barcode_printer_id`	varchar(20)	NOT NULL,-->
        <!--        `collector_id`	varchar(20)	NULL,-->
        <!--        `prescribe_code`	bigint	NOT NULL-->
        <!--        );-->